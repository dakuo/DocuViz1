<!DOCTYPE HTML>
<html>
<head>
	<title>{{ APPLICATION_NAME }}</title>
	<style>
		/*! normalize.css v1.0.2 | MIT License | git.io/normalize */@import url(http://weloveiconfonts.com/api/?family=fontawesome);article,aside,details,figcaption,figure,footer,header,hgroup,nav,section,summary{display:block}audio,canvas,video{display:inline-block;*display:inline;*zoom:1}audio:not([controls]){display:none;height:0}[hidden]{display:none}html{-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}body{margin:0}a:focus{outline:thin dotted}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:700}dfn{font-style:italic}pre{white-space:pre;white-space:pre-wrap;word-wrap:break-word}q{quotes:none}q:after,q:before{content:'';content:none}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-.5em}sub{bottom:-.25em}dd,dl,dt,menu,ol,ul{margin:0;padding:0;list-style-type:none}img{border:0;-ms-interpolation-mode:bicubic}svg:not(:root){overflow:hidden}figure,form{margin:0}fieldset{margin:0;padding:0}legend{border:0;padding:0;white-space:normal;*margin-left:-7px}button,input,select,textarea{font-size:100%;margin:0;vertical-align:baseline;*vertical-align:middle}button,input{line-height:normal}button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer;*overflow:visible}button[disabled],input[disabled]{cursor:default}input[type=checkbox],input[type=radio],input[type=text]{-moz-box-sizing:border-box;box-sizing:border-box;padding:0;*height:13px;*width:13px}input[type=search]{-webkit-appearance:textfield;-moz-box-sizing:content-box;box-sizing:content-box}input[type=search]::-webkit-search-cancel-button,input[type=search]::-webkit-search-decoration{-webkit-appearance:none}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}textarea{overflow:auto;vertical-align:top}table{border-collapse:collapse;border-spacing:0}th{font-weight:400}.media>.mediaBody{display:table-cell;vertical-align:top;width:10000px!important;*display:block;*zoom:1;*width:auto!important}.box,.box .boxFoot,.box .boxHead,.form .field,.media{zoom:1}.box .boxFoot:after,.box .boxFoot:before,.box .boxHead:after,.box .boxHead:before,.box:after,.box:before,.form .field:after,.form .field:before,.media:after,.media:before{content:" ";display:table}.box .boxFoot:after,.box .boxHead:after,.box:after,.form .field:after,.media:after{clear:both}.form .fieldGroupInline>li,.listInline>li,.listInlineDivider li{display:inline-block;*display:inline;*zoom:1}.txtC{text-align:center}.txtL{text-align:left}.txtR{text-align:right}.txtT{vertical-align:top}.txtB{vertical-align:bottom}.txtM{vertical-align:middle}.hideVisually{border:0;clip:rect(0 0 0 0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}.hideVisually.focusable:active,.hideVisually.focusable:focus{clip:auto;height:auto;margin:0;overflow:visible;position:static;width:auto}.hideFully{display:none!important;visibility:hidden}html{font-size:100%}body{font-size:14px;font-size:.875rem;line-height:1.5;color:#403043}body,input,select,textarea{font-family:Helvetica,Arial,sans-serif}.h1,.h2,.h3,.h4,.h5,.h6,h1,h2,h3,h4,h5,h6{font-style:normal}.h1,h1{font-size:30px;font-size:1.875rem}.h2,h2{font-size:17px;font-size:1.0625rem}.h3,h3{font-size:14px;font-size:.875rem}.h4,.h5,h4,h5{font-size:13px;font-size:.8125rem}.h6,h6{font-size:11px;font-size:.6875rem}code,pre{font-family:Consolas,Monaco,"Lucida Console",monospace}.typeHighlight{color:#5290d2}.typeLowlight{color:#999}a{color:#5290d2;text-decoration:none}a:focus,a:hover{color:#8ebaf4}.box{position:relative}.box .boxBody,.box .boxFoot,.box .boxHead{padding:0 20px}.boxBasic{border-radius:6px}.nav{list-style:none;margin-left:0}.nav:after{content:"";display:table;clear:both}.nav>li,.nav>li>a{display:inline-block;*display:inline;zoom:1}.nav--stacked>li{display:list-item}.nav--stacked>li>a{display:block}.nav--banner{text-align:center}.nav--block{line-height:1;letter-spacing:-.31em;word-spacing:-.43em;white-space:nowrap}.nav--block>li{letter-spacing:normal;word-spacing:normal}.nav--block>li>a{padding:12px}.nav--fit{display:table;width:100%}.nav--fit>li{display:table-cell}.nav--fit>li>a{display:block}.nav--keywords>li:after{content:"\002C" "\00A0"}.nav--keywords>li:last-child:after{display:none}hr{border:0;border-bottom:1px solid #5290d2}ol,ul{list-style-type:none}ol>li,ul>li{margin:.2em 0}.lvn>li{padding-top:0!important;padding-bottom:0!important}.lvs>li{padding-top:5px!important;padding-bottom:5px!important}.lvm>li{padding-top:10px!important;padding-bottom:10px!important}.lvl>li{padding-top:20px!important;padding-bottom:20px!important}.lhn>li{padding-left:0!important;padding-right:0!important}.lhs>li{padding-left:5px!important;padding-right:5px!important}.lhm>li{padding-left:10px!important;padding-right:10px!important}.lhl>li{padding-left:20px!important;padding-right:20px!important}.listBordered>li{padding:10px;border-top:1px solid #999}.listBordered>li:first-child{border-top:1px solid transparent}.listBulleted>li{list-style-type:disc;margin-left:1.3em}.listInline>li{vertical-align:middle;padding-right:10px}.listInlineDivider li{border-left:solid 2px #999;padding:0 .4em 0 .65em;margin:0}.listInlineDivider:first-child{border:0;padding-left:0}.listOrdered li{margin-left:1.4em;list-style-type:decimal}.media>.mediaImg{float:left;margin-right:10px}.media>.mediaImg>img{display:block}.media>.mediaImgExt{float:right;margin-left:10px;margin-right:0}.mediaInline{vertical-align:middle}.mediaInline>img,.mediaInline>span{display:inline-block;vertical-align:middle}.form .select select,.form .text input,.form .text textarea{-moz-box-sizing:border-box;box-sizing:border-box;width:100%;padding:4px;border:1px solid #666}.form .fieldGroup,.form .fieldGroupInline,.form .fieldItem{display:table-cell;width:10000px;*width:auto;*display:block;*zoom:1}::-webkit-input-placeholder{color:#999}:-moz-placeholder{color:#999}:-ms-input-placeholder{color:#999}.placeholder{color:#999}.form .col :first-child{margin-top:0}.form .col :last-child{margin-bottom:0}.form .fieldLabel{margin-bottom:2px;min-height:1px;display:block;cursor:pointer;font-weight:700}.form .labelLeft .fieldLabel,.form label.labelLeft{width:30%;float:left;padding:4px 13px 4px 0;text-align:right}.form .select select,.form .text input{width:100%}.form .checkbox,.form .radio{position:relative}.form .checkbox label,.form .radio label{display:block;width:auto;padding-left:1.4em;*zoom:1;*padding-left:0;vertical-align:middle}.form .checkbox input,.form .radio input{margin-right:5px;padding:0;float:left;position:relative;top:4px;border:0;line-height:1.5em;vertical-align:middle}.form .checkbox input[type=radio],.form .radio input[type=radio]{top:4px}@media screen and (-webkit-min-device-pixel-ratio:0){.form .checkbox input,.form .radio input{top:.35em}.form .checkbox input[type=radio],.form .radio input[type=radio]{left:1px}}.form .text textarea{width:100%;padding:8px}.form .fieldGroup{margin:0}.form .fieldGroup>li{margin:5px 0}.form .fieldGroup>li>label{display:block;margin-bottom:2px}.form .fieldGroup:after,.form .fieldGroup:before{display:table;content:"";clear:both}.form .fieldGroupInline>li{margin-left:13px;float:none}.form .fieldGroupInline>li:first-child{margin-left:0}.form .fieldGroupInline>li>label{display:inline-block;margin:0}.form .fieldGroupInline .fieldItem,.form .fieldGroupInline label{vertical-align:middle;float:none;display:inline-block;width:auto}.form .fieldGroupInline .checkbox input,.form .fieldGroupInline .radio input{top:auto;float:none;vertical-align:middle}.form .fieldGroupInline .checkbox label,.form .fieldGroupInline .radio label{padding-left:0}.form .fieldRange>li{display:table-cell;vertical-align:middle}.form .fieldRange .rangeLabel{padding:0 10px}button{background:0 0;border:0}.btn{padding:.8em 2.2em;margin:0;display:inline-block;font-weight:400;font-size:16px;font-size:1rem;text-decoration:none;cursor:pointer;border:0;background:0 0;text-align:center}.btnDefault{background:#272e38;color:#fff}.curtain:before{display:block;content:"";position:absolute;top:0;left:0;height:100%;width:100%}.curtain--hover-default:hover:before{background:#000;opacity:.6;z-index:1}.curtain--animate{-webkit-transition:background 200ms ease-out,opacity 200ms ease-out;transition:background 200ms ease-out,opacity 200ms ease-out;-webkit-transform:translate3d(0,0,0);transform:translate3d(0,0,0)}.curtain--default:before{background:#2b2b2b;opacity:.75}.curtain--skin-1:before{background:#111;opacity:.5}.box,.form,.form .field,.listBordered,.listBulleted,.listInline,.listInlineDivider,.listOrdered,.media,p{margin-top:1.5em;margin-bottom:1.5em}table .media,table blockquote,table dl,table h1,table h2,table h3,table h4,table h5,table h6,table ol,table p,table pre,table ul{margin-top:0;margin-bottom:0}.pan{padding:0!important}.man{margin:0!important}.pvn{padding-top:0!important;padding-bottom:0!important}.mvn{margin-top:0!important;margin-bottom:0!important}.phn{padding-left:0!important;padding-right:0!important}.mhn{margin-left:0!important;margin-right:0!important}.ptn{padding-top:0!important}.mtn{margin-top:0!important}.prn{padding-right:0!important}.mrn{margin-right:0!important}.pbn{padding-bottom:0!important}.mbn{margin-bottom:0!important}.pln{padding-left:0!important}.mln{margin-left:0!important}.pas{padding:5px!important}.mas{margin:5px!important}.pvs{padding-top:5px!important;padding-bottom:5px!important}.mvs{margin-top:5px!important;margin-bottom:5px!important}.phs{padding-left:5px!important;padding-right:5px!important}.mhs{margin-left:5px!important;margin-right:5px!important}.pts{padding-top:5px!important}.mts{margin-top:5px!important}.prs{padding-right:5px!important}.mrs{margin-right:5px!important}.pbs{padding-bottom:5px!important}.mbs{margin-bottom:5px!important}.pls{padding-left:5px!important}.mls{margin-left:5px!important}.pam{padding:7px!important}.mam{margin:7px!important}.pvm{padding-top:7px!important;padding-bottom:7px!important}.mvm{margin-top:7px!important;margin-bottom:7px!important}.phm{padding-left:7px!important;padding-right:7px!important}.mhm{margin-left:7px!important;margin-right:7px!important}.ptm{padding-top:7px!important}.mtm{margin-top:7px!important}.prm{padding-right:7px!important}.mrm{margin-right:7px!important}.pbm{padding-bottom:7px!important}.mbm{margin-bottom:7px!important}.plm{padding-left:7px!important}.mlm{margin-left:7px!important}.pal{padding:11px!important}.mal{margin:11px!important}.pvl{padding-top:11px!important;padding-bottom:11px!important}.mvl{margin-top:11px!important;margin-bottom:11px!important}.phl{padding-left:11px!important;padding-right:11px!important}.mhl{margin-left:11px!important;margin-right:11px!important}.ptl{padding-top:11px!important}.mtl{margin-top:11px!important}.prl{padding-right:11px!important}.mrl{margin-right:11px!important}.pbl{padding-bottom:11px!important}.mbl{margin-bottom:11px!important}.pll{padding-left:11px!important}.mll{margin-left:11px!important}.paxl{padding:21px!important}.maxl{margin:21px!important}.pvxl{padding-top:21px!important;padding-bottom:21px!important}.mvxl{margin-top:21px!important;margin-bottom:21px!important}.phxl{padding-left:21px!important;padding-right:21px!important}.mhxl{margin-left:21px!important;margin-right:21px!important}.ptxl{padding-top:21px!important}.mtxl{margin-top:21px!important}.prxl{padding-right:21px!important}.mrxl{margin-right:21px!important}.pbxl{padding-bottom:21px!important}.mbxl{margin-bottom:21px!important}.plxl{padding-left:21px!important}.mlxl{margin-left:21px!important}[class*=fontawesome-]:before{font-family:FontAwesome,sans-serif}.center{position:absolute;left:50%;top:45%;-webkit-transform:translate(-50%,-50%);transform:translate(-50%,-50%)}body,html{height:100%}.btn--default{background:#ff4e45;padding:10px 15px;color:#fff;font-size:12px}@font-face{font-family:icomoon;src:url(http://kubiwork.com/othersites/docuviz/fonts/icomoon.eot?-55t6of);src:url(http://kubiwork.com/othersites/docuviz/fonts/icomoon.eot?#iefix-55t6of) format("embedded-opentype"),url(http://kubiwork.com/othersites/docuviz/fonts/icomoon.woff?-55t6of) format("woff"),url(http://kubiwork.com/othersites/docuviz/fonts/icomoon.ttf?-55t6of) format("truetype"),url(http://kubiwork.com/othersites/docuviz/fonts/icomoon.svg?-55t6of#icomoon) format("svg");font-weight:400;font-style:normal}[class*=" icon-"],[class^=icon-]{font-family:icomoon;speak:none;font-style:normal;font-weight:400;font-variant:normal;text-transform:none;line-height:1;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-icon--upload:before{display:block;content:"\65"}.icon-icon--document:before{content:"\48"}.site-wrap{height:100%}.billboard{height:100%;background-image:url(http://kubiwork.com/site/images/home-pattern.png),url(http://kubiwork.com/othersites/docuviz/home-image.jpg);background-repeat:repeat,no-repeat;background-position:center center,center center;background-size:auto,cover}.billboard__content{margin:0 auto;text-align:center}.billboard__content .content__title{font-size:90px;margin:0 0 40px;color:#f0f1f5;position:relative;text-transform:uppercase}.billboard__content .content__title:before{position:absolute;content:"";width:100%;height:1px;bottom:0;left:0;background:#666}.billboard__content .content__description{display:block;font-size:15px;margin-bottom:40px;color:#aaa;line-height:1.9}.google--upload{height:100%;width:100%;background:#f0f1f5}.google--upload .content>a{padding:50px 150px;display:block;text-align:center;overflow:hidden;color:#666;border:3px dashed #aaa;-webkit-transition:all 100ms ease-out;transition:all 100ms ease-out;cursor:pointer}.google--upload .content>a:hover{color:#fff;background:#2b2b2b;border:3px dashed #2b2b2b}.google--upload .content>a:hover>span:nth-child(2){color:#f0f1f5}.google--upload .content>a>span{-webkit-transition:all 100ms ease-out;transition:all 100ms ease-out}.google--upload .content>a>span:nth-child(2){display:block;text-transform:uppercase;font-weight:700;margin-top:20px;color:#666;font-size:26px}.google--upload .content>a>span:last-child{display:block;margin-top:10px;color:#999;line-height:1.8;font-size:16px}.icon-icon--document{font-size:160px;display:block;position:relative;left:16px}.app__controller{padding:20px}.progressBar{-webkit-appearance:none;-moz-appearance:none;appearance:none;border:0;color:#00f;width:100%}.progressBar::-webkit-progress-bar{background:#f0f1f5}.progressBar::-moz-progress-bar{background:#5290d2}.progressBar::-webkit-progress-value{background:#5290d2}.loading-screen{width:100%;text-align:center}.loading-screen .content{width:60%}.loading-screen .visual-log{position:absolute;bottom:20px;width:700px;left:50%;margin-left:-355px}.loading-screen .visual-log span{display:block;line-height:1.8}
	</style>
	<script type="text/javascript">
	//For GAPI load check
	var pickerApiLoaded = false;
	(function() {
		var po = document.createElement('script');
		po.type = 'text/javascript';
		po.async = true;
		po.src = '//plus.google.com/js/client:plusone.js';

		var s = document.getElementsByTagName('script')[0];
		s.parentNode.insertBefore(po, s);

	})();
	/* Must be put after onApiLoad() function
	(function() {
		var po = document.createElement('script');
		po.type = 'text/javascript';
		po.async = true;
		po.src = 'https://apis.google.com/js/api.js?onload=onApiLoad';
		var s = document.getElementsByTagName('script')[0];
		s.parentNode.insertBefore(po, s);

	})();
*/
</script>

<!-- JavaScript specific to this application that is not related to API calls -->
<script
src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"
type="text/javascript"></script>
<script
src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"
type="text/javascript"></script>
<link rel="stylesheet"
href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/start/jquery-ui.css"
type="text/css" media="all"></link>
<script
src="//d3js.org/d3.v3.min.js" charset="utf-8"
type="text/javascript"></script>
</head>

<body>

	<div class="site-wrap">

		<section class="billboard curtain curtain--default">
			<div class="billboard__content center">
				<h2 class="content__title">
					Docuviz
				</h2>

				<span class="content__description">
					Lorem ipsum dolor sit amet, consectetur adipisicing elit. Odit laudantium quaerat corporis nisi suscipit. Quod quaerat perspiciatis reiciendis expedita nesciunt totam ab, architecto necessitatibus recusandae pariatur ad, voluptatem eum eaque?
				</span>

				<!-- Google Log in Btn -->
				<div id="gConnect">
					<button class="g-signin"
					data-scope="email https://www.googleapis.com/auth/drive"
					data-clientId="{{ CLIENT_ID }}" data-accesstype="online"
					data-callback="onSignInCallback" data-theme="dark" data-width="wide"
					data-cookiepolicy="single_host_origin" data-approvalprompt="force"></button>
				</div>
			</div>
		</section>

		<section class="google--upload">
			<div class="content center">
				<a class="createPicker2">
					<i class="icon icon-icon--document"></i>
					<span>Choose a file</span>
					<span>Choose a Google Drive Document to see the revision history visualization</span>
				</a>
			</div>
		</section>

		<section class="loading-screen">
		  <div class="content center">
		    <progress class='progressBar' max='100' value='20'><span>0</span>%</progress>
		    <h2>Loading...</h2>
		  </div>

		  <div class="visual-log">
		    <h2>Visualization Log</h2>

		    <div class="log__content">
		      <span>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Repudiandae, quibusdam.</span>
		      <span>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Repudiandae, quibusdam.</span>
		      <span>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Repudiandae, quibusdam.</span>
		    </div>

		  </div>
		</section>


		<div id="authOps" style="display: none">

			<div id="progressBar" style="display:none"></div>

			<div id="slider" style="display:none">
				<p id = "sliderLable">
					<label for="amount">Displaying Revisions:</label> <input type="text"
					id="amount" style="border: 0; color: #f6931f; font-weight: bold;"></input>
				</p>
				<div id="sliderBar" style="margin-left:10px; margin-right:10px;"></div>

				<form>
					<div id="radio">
						<input type="radio" id="timescale" name="radio" value="timescale"><label for="timescale">Time Scaled</label>
						<input type="radio" id="equaldistance" name="radio" value="equaldistance" checked="checked"><label for="equaldistance">Equal Distance</label>
					</div>
				</form>

			</div>



			<pre id="vizChart"></pre>

	  		<!-- <h2>Pick a Google Drive Document to see the revision history visualization</h2>
	  		<p></p> -->

	  		<!-- <button id="createPicker2">Visualize your
	  		Document</button> -->

	  		<!-- <h2>Sign out and Disconnect with this app</h2>
	  		<p></p>
	  		<button id="disconnect">Sign out</button> -->

	  		<!-- h2>User's profile information</h2>
	  		<p>This data is retrieved client-side by using the Google
	  			JavaScript API client library.</p>
	  		<div id="profile"></div>

	  		<h2>User's friends that are visible to this app</h2>
	  		<p>This data is retrieved from your server, where your server
	  			makes an authorized HTTP request on the user's behalf.</p>
	  		<p>If your app uses server-side rendering, this is the section you
	  			would change using your server-side templating system.</p>
	  			<div id="visiblePeople"></div -->

	  				<!-- <h2>Visualization Logs</h2> -->

	  				<pre id="vizResult"></pre>


	  		<!-- Hidden <FORM> to submit the SVG data to the server, which will convert it to SVG/PDF/PNG downloadable file.
	  		The form is populated and submitted by the JavaScript below. -->
	  		<form id="svgform" method="post" action="saveImage">
	  			<input type="hidden" id="output_format" name="output_format" value="">
	  			<input type="hidden" id="data" name="data" value="">
	  		</form>

	  		<!-- <button id="saveButton">Save Image</button> -->
	  		<!--
	  		<h2>Authentication Logs</h2>
	  		<pre id="authResult"></pre>
	  	-->
	  	<!--  Hidden Dialog FORM to submit the changing author request -->
	  	<div id="dialog_form" title="Segment Function">
	  		<form>
	  			<select id="author_list"></select>
	  			<input type="hidden" id="change_doc_id" name="doc_id" value="">
	  			<input type="hidden" id="change_seg_id" name="seg_id" value="">
	  			<input type="hidden" id="change_rev_id" name="rev_id" value="">
	  		</form>
	  	</div>
	  	<!-- Hidden Content dialog -->
	  	<div id="content" title="Content">
	  	</div>
	  </div>
	</div>

</body>
<script type="text/javascript">
	var helper = (function() {
		var authResult = undefined;
		return {
			/**
			 * Hides the sign-in button and connects the server-side app after
			 * the user successfully signs in.
			 *
			 * @param {Object} authResult An Object which contains the access token and
			 *   other authentication information.
			 */
			 onSignInCallback : function(authResult) {
				//TODO may be deleted after deployment
				$('#authResult').hide();

				// KUBI Components
				$('.billboard').hide();
				$('.google--upload').show();
				$('.loading-screen').hide();

				$('#authResult').html('Auth Result:<br/>');
				for ( var field in authResult) {
					//not work with chrome, but doesn't matter, just debug
					//$('#authResult').append(' ' + field + ': ' + authResult[field] + '<br/>');
				}

				if (authResult['access_token']) {
					// The user is signed in
					this.authResult = authResult;
					helper.connectServer();

					// After we load the Google+ API, render the profile data from Google+.
					gapi.client.load('plus', 'v1', this.renderProfile);

				} else if (authResult['error']) {
					// There was an error, which means the user is not signed in.
					// As an example, you can troubleshoot by writing to the console:
					console.log('There was an error: ' + authResult['error']);
					$('#authResult').append('Logged out');
					$('#authOps').hide('slow');
					$('#gConnect').show();
				}
				console.log('authResult', authResult);
			},

			/**
			 * Retrieves and renders the authenticated user's Google+ profile.
			 * For now, keep it for displaying the page after connect/re-connect
			 */
			 renderProfile : function() {
			 	var request = gapi.client.plus.people.get({
			 		'userId' : 'me'
			 	});
			 	request
			 	.execute(function(profile) {
			 		$('#profile').empty();
			 		if (profile.error) {
			 			$('#profile').append(profile.error);
			 			return;
			 		}
			 		$('#profile')
			 		.append(
			 			$('<p><img src=\"' + profile.image.url + '\"></img></p>'));
			 		$('#profile').append(
			 			$('<p>Hello ' + profile.displayName
			 				+ '!<br />Tagline: '
			 				+ profile.tagline + '<br />About: '
			 				+ profile.aboutMe + '</p>'));
			 		if (profile.cover && profile.coverPhoto) {
			 			$('#profile')
			 			.append(
			 				$('<p><img src=\"' + profile.cover.coverPhoto.url + '\"></img></p>'));
			 		}
			 	});
			 	$('#authOps').show('slow');
			 	$('#gConnect').hide();
			 },
			/**
			 * Calls the server endpoint to disconnect the app for the user.
			 */
			 disconnectServer : function() {
				// Revoke the server tokens
				$.ajax({
					type : 'POST',
					url : window.location.href + 'disconnect',
					async : false,
					success : function(result) {
						console.log('revoke response: ' + result);
						$('#authOps').hide('slow');

						//$('#profile').empty();
						//$('#visiblePeople').empty();

						$('#authResult').empty();
						$('#vizResult').empty();
						$('#vizChart').empty();

						$('#slider').hide();
						$('#saveButton').attr("disabled",
							true);

						$('#gConnect').show();
					},
					error : function(e) {
						console.log(e);
					}
				});
			},
			/**
			 * Calls the server endpoint to connect the app for the user. The client
			 * sends the one-time authorization code to the server and the server
			 * exchanges the code for its own tokens to use for offline API access.
			 * For more information, see:
			 *   https://developers.google.com/+/web/signin/server-side-flow
			 */
			 connectServer : function() {
			 	console.log(this.authResult.code);
			 	$.ajax({
			 		type : 'POST',
			 		url : window.location.href + 'connect?state={{ STATE }}',
			 		contentType : 'application/octet-stream; charset=utf-8',
			 		success : function(result) {
			 			console.log(result);

						//helper.people();
					},
					processData : false,
					data : this.authResult.code
				});
			 },
			/**
			 * Calls the server endpoint to get the list of people visible to this app.
			 *
			people : function() {

				$.ajax({
				type: 'GET',
				url: window.location.href + 'people',
				contentType: 'application/octet-stream; charset=utf-8',
				success: function(result) {
				  helper.appendCircled(result);
				},
				processData: false
				});

			},

			/**
			 * Displays visible People retrieved from server.
			 *
			 * @param {Object} people A list of Google+ Person resources.
			 *
			appendCircled : function(people) {
				$('#visiblePeople').empty();

				$('#visiblePeople').append(
						'Number of people visible to this app: '
								+ people.totalItems + '<br/>');
				for ( var personIndex in people.items) {
					person = people.items[personIndex];
					$('#visiblePeople').append(
							'<img src="' + person.image.url + '">');
				}
			},
			/**
			 * Create and render a Picker object for picking user Docs.
			 */
			 createPicker : function(oauthToken) {

				//For GAPI load check
				if (pickerApiLoaded && oauthToken) {

					var picker = new google.picker.PickerBuilder()
					.enableFeature(google.picker.Feature.NAV_HIDDEN)
					.addView(google.picker.ViewId.FOLDERS)
					.setOAuthToken(oauthToken)
					.setDeveloperKey('AIzaSyCkhO5QlXxaVMmM3EqybZeC3BbFHGsxo20')
					.setCallback(
						function(data) {
							var doc_id = 'nothing';
							var doc_name = 'no name';
							if (data[google.picker.Response.ACTION] == google.picker.Action.PICKED) {
											// Deal with vizChart
											$("#slider").hide();

											$("#vizChart").empty();
											$('#vizResult').empty();
											$('.log__content').empty();


											$('.createPicker2').attr("disabled",
												true);
											$('#saveButton').attr("disabled",
												true);

											// KubiTODO Remove this when switch to HTML5 ProgressBar
											// $('#progressBar').show();

											// Show Loading Page
											$('.loading-screen').show();

											$("#author_list").empty();

											/* [~] Hide Google Upload */
											$(".google--upload").hide();

											var doc = data[google.picker.Response.DOCUMENTS][0];
											doc_id = doc[google.picker.Document.ID];
											doc_name = doc[google.picker.Document.NAME];
											helper.retrieveRevisions(doc_id,
												doc_name);

										} else {
											$('.createPicker2').attr("disabled",
												false);
										}
									}).build();
					picker.setVisible(true);
				} else {
					gapi.load('picker');
					pickerApiLoaded = true;
				}
			},
			/**
			 * Calls the server endpoint to start retrieve the list of revisions visible to this app.
			 */
			 retrieveRevisions : function(doc_id, doc_name) {

			 	$('.log__content').append("<p> HUHU Viz Result for Document: " + doc_name + '</p>');

			 	// $('#vizResult').append(
			 	// 	'HUHU Viz Result for Document: ' + doc_name + '<br/>');

			 	$.post(window.location.href + 'revisions', {
			 		'doc_id' : doc_id,
			 		'doc_name' : doc_name
			 	}, function(result) {
			 		console.log("Start Retrieving Revisions");
			 		console.log(result);


			 		// $('#vizResult').append(result + ' <br/>');
			 		helper.pollingTask(doc_id, doc_name, 'download');
			 	});

			 },

			/**
			 * Calls the server endpoint to start diff the already downloaded revisions.
			 */
			 diffRevisions : function(doc_id, doc_name) {

			 	$('.log__content').append(
			 				 	 	'<p>HAHA Diff Result for Document: ' + doc_name + '</p>');

			 	// $('#vizResult').empty();

			 	// $('#vizResult').append(
			 	// 	'HAHA Diff Result for Document: ' + doc_name + '<br/>');

			 	$.post(window.location.href + 'diffrevisions', {
			 		'doc_id' : doc_id,
			 		'doc_name' : doc_name
			 	}, function(result) {
			 		console.log("Start Differentiating Revisions");
			 		console.log(result);

			 		$('.log__content').append(result);
			 		// $('#vizResult').append(result + ' <br/>');

					//TODO will really process this sentence??
					if (helper.pollingTask(doc_id, doc_name, 'diff')){
						renderVisualization(doc_id, doc_name);
					}
				});

			 },
			/**
			 * Call the server endpoint to check the status of visualizing task
			 */
			 pollingTask : function(doc_id, doc_name, mode) {
			 	$.ajax({
			 		type : 'GET',
			 		url : window.location.href + 'polling?mode=' + mode
			 		+ '&doc_id=' + doc_id,
			 		contentType : 'application/octet-stream; charset=utf-8',

			 		success : function(result) {
			 			console.log("Polling Status of Task " + doc_id);
			 			console.log(result);

						// Deal with the Viz Log Effect
						$('#vizResult').effect(
							"highlight",
							{},
							500,
							function() {
								setTimeout(function() {
									$("#effect").removeAttr("style").hide()
									.fadeIn();
								}, 1000);
							});

						// KUBI progressBar

						// Deal with progressBar
						// $("#progressBar").progressbar({
						// 	value : parseInt(result)
						// });
			 			$('.progressBar').val(parseInt(result));

						if (mode === "download") {
							if (result === "100") {

								$('.log__content').append('Download Done!');
								// $('#vizResult').append('Download Done! <br/>');

								// TODO should be initiated in upper level not inside polling?
								// initiate the diff algorithm
								helper.diffRevisions(doc_id, doc_name);

								return;
							}
							$('.log__content').append(
								'Downloading ' + result + '%');
							// $('#vizResult').append(
							// 	'Downloading ' + result + '%. <br/>');
						} else if (mode === "diff") {
							if (result === "100") {
								$('.createPicker2').attr("disabled", false);
								$('#progressBar').hide();
								$('#saveButton').attr("disabled",false);
								$('#vizResult').append('Diff Done! <br/>');

								// TODO should be initiated in upper level not inside polling?
								// initiate the viz
								helper.renderVisualization(doc_id, doc_name);
								return;
							}
							$('#vizResult').append(
								'Diff-ing ' + result + '%. <br/>');
						}

						helper.pollingTask(doc_id, doc_name, mode);
					}
				});
},
			/**
			 * Retrieves and renders the history flow.
			 */
			 renderVisualization : function(doc_id, doc_name) {
			 	$('#vizResult').empty();
			 	$('#vizChart').empty();

			 	$('.loading-screen').hide();

			 	$('#slider').hide();
			 	$('#vizResult').append(
			 		'Viz Result for Document: ' + doc_name + '<br/>');
			 	$('#change_doc_id').val(doc_id);

				//TODO change ajax to post
				$.ajax({
					type : 'POST',
					url : window.location.href + 'viz?doc_id=' + doc_id,
					contentType : 'application/octet-stream; charset=utf-8',
					success : function(result) {
						console.log("Start Viz Revisions");

								//$('#vizResult').append(result + ' <br/>');

								/*
								 ** To Prepare the SVG Convas for drawing the history flow
								 */
								 var width = 1280, height = 900, margin = {
								 	'top' : 20,
								 	'right' : 10,
								 	'bottom' : 10,
								 	'left' : 10
								 };

								 var svg = d3.select("#vizChart").append("svg")
								 .attr(
								 	"width",
								 	width + margin.left
								 	+ margin.right)
								 .attr(
								 	"height",
								 	height + margin.top
								 	+ margin.bottom)
								 .attr(
								 	"margin-left",
								 	margin.left
								 	)
								 .attr(
								 	"margin-top",
								 	margin.top
								 	);


								/*
								 * Draw the history flow
								 */
								 var dataset = $.parseJSON(result);
								 historyflow(svg, width, height, dataset);

								 var num_revisions = dataset.revisions.length;

								 $("#sliderBar")
								 .slider({
								 	range: true,
								 	min: 1,
								 	max: num_revisions,
								 	values: [1,num_revisions],
								 	slide: function( event, ui ) {
								    	  // revision start from 0, so we need to change the index minus one

								    	  $( "#amount" ).val( "Rev: " + ui.values[ 0 ] + " - Rev: " + ui.values[ 1 ] );

										//TODO change ajax to post
										$.ajax({
											type : 'POST',
											url : window.location.href + 'viz?doc_id=' + doc_id+'&end_rev_index='+(ui.values[ 1 ]-1) +'&start_rev_index='+(ui.values[ 0 ]-1),
											contentType : 'application/octet-stream; charset=utf-8',
											success : function(result) {
												console.log("Start Viz Revisions");

														//$('#vizResult').append(result + ' <br/>');

														/*
														 ** To Prepare the SVG Convas for drawing the history flow
														 */
														 var width = 1280, height = 900, margin = {
														 	'top' : 20,
														 	'right' : 10,
														 	'bottom' : 10,
														 	'left' : 10
														 };

														 $('#vizChart').fadeOut(1000,function(){
														 	$('#vizChart').empty();
														 	var svg = d3.select("#vizChart").append("svg")
														 	.attr(
														 		"width",
														 		width + margin.left
														 		+ margin.right)
														 	.attr(
														 		"height",
														 		height + margin.top
														 		+ margin.bottom)
														 	.attr(
														 		"margin-left",
														 		margin.left
														 		)
														 	.attr(
														 		"margin-top",
														 		margin.top
														 		);
															/*
															 * Draw the history flow
															 */
															 var dataset = $.parseJSON(result);
															 var timescale_flag = $('input[name=radio]:checked').val();

															 if(timescale_flag=="timescale")
															 	historyflow(svg, width, height, dataset, true);
															 else
															 	historyflow(svg, width, height, dataset, false);
															 $('#vizChart').fadeIn();
															});

}
});
}
});

$( "#amount" ).val( "Rev: " + $( "#sliderBar" ).slider( "values", 0 ) +
	" - Rev: " + $( "#sliderBar" ).slider( "values",  1) );
$("#slider").show();

},
processData : false,
data : this.authResult.code
});

$('#authOps').show('slow');
},

			/*
			 *	get the segment content data
			 *
			 */
			 retrieveSegmentContent : function(doc_id, segment_id) {
			 	$('#vizResult').empty();
			 	$('#vizResult').append(
			 		'Selected Segment #' + segment_id
			 		+ ' Content is: <br/>');


			 	var doOk = function() {
			 		$("#content").dialog("close");
			 	}

			 	var dialogOpts = {
			 		modal: true,
			 		buttons: {
			 			"Ok!": doOk
			 		},
			 		hight: 800,
			 		width: 500,
			 		autoOpen: false
			 	};
			 	$('#content').dialog(dialogOpts);

			 	$.ajax({
			 		type : 'POST',
			 		url : window.location.href + 'seg?doc_id=' + doc_id
			 		+ '&segment_id=' + segment_id,
			 		contentType : 'application/octet-stream; charset=utf-8',
			 		success : function(result) {
			 			console.log("Retrieved the Segment " + segment_id
			 				+ " Result ");

			 			$('#vizResult').append(result + ' <br/>');
			 			$('#content').html(result+'<span></span>');
			 		},
			 		processData : false,
			 		data : this.authResult.code
			 	});

			 	$('#content').removeClass('ui-dialog-buttonpane ui-widget-content ui-helper-clearfix');
			 	$('#content').dialog("open");

			 },



			/*
			 *	change the segment and all its children segments' author
			 *
			 */
			 changeSegmentAuthor : function(doc_id, revision_id, segment_id, author_id) {

			 	$.ajax({
			 		type : 'POST',
			 		url : window.location.href + 'segAuthor?doc_id=' + doc_id
			 		+ '&segment_id=' + segment_id + '&author_id=' + author_id + '&rev_id='+revision_id,
			 		contentType : 'application/octet-stream; charset=utf-8',
			 		success : function(result) {
			 			console.log("revision id: "+revision_id);
			 			$('#vizResult').append(result + ' <br/>');

			 		},
			 		processData : false,
			 		data : this.authResult.code
			 	});




			 	$('#vizChart').fadeOut(1000,function(){
			 		$('#vizChart').empty();
									/*
									 ** To Prepare the SVG Convas for drawing the history flow
									 */
									 var width = 1280, height = 900, margin = {
									 	'top' : 20,
									 	'right' : 10,
									 	'bottom' : 10,
									 	'left' : 10
									 };
									 var svg = d3.select("#vizChart").append("svg")
									 .attr(
									 	"width",
									 	width + margin.left
									 	+ margin.right)
									 .attr(
									 	"height",
									 	height + margin.top
									 	+ margin.bottom)
									 .attr(
									 	"margin-left",
									 	margin.left
									 	)
									 .attr(
									 	"margin-top",
									 	margin.top
									 	);
									/*
									 * Draw the history flow
									 */
									// refresh the chart
									$.ajax({
										type : 'POST',
										url : window.location.href + 'viz?doc_id=' + doc_id,
										contentType : 'application/octet-stream; charset=utf-8',
										success : function(result) {
											console.log("Start Redraw Visualization");

											var dataset = $.parseJSON(result);
											historyflow(svg, width, height, dataset);
											$('#vizChart').fadeIn();
										}
									});


								});

},

			// save the svg object to image locally
			saveImage : function() {
				$('#vizResult').empty();
				$('#vizResult').append(
					'Save Image <br/>');

				d3.select("svg").attr("version", 1.1).attr("xmlns","http://www.w3.org/2000/svg");
				var svg = document.getElementsByTagName('svg')[0];
				var svg_xml = (new XMLSerializer).serializeToString(svg);

				// Submit the <FORM> to the server.
				// The result will be an attachment file to download.
				var form = document.getElementById("svgform");
				form['output_format'].value = "";
				form['data'].value = svg_xml ;
				form.submit();

			}
		};
	})();

/**
 *  UI
 */

	/**
	 * Perform jQuery initialization and check to ensure that you updated your
	 * client ID.
	 */
	 $(document)
	 .ready(
	 	function() {
	 		$('#radio').buttonset();

	 		/* [~] Hide Google Upload */
	 		$(".google--upload").hide();
	 		$(".loading-screen").hide();

	 		$('input[name=radio]').click(function() {
	 			var value = $('input[name=radio]:checked').val();

	 			if(value=="timescale")
	 			{
	 				$('#vizChart').fadeOut(1000,function(){
	 					var doc_id = $('#change_doc_id').val();

	 					$('#vizChart').empty();
									/*
									 ** To Prepare the SVG Convas for drawing the history flow
									 */
									 var width = 1280, height = 900, margin = {
									 	'top' : 20,
									 	'right' : 10,
									 	'bottom' : 10,
									 	'left' : 10
									 };
									 var svg = d3.select("#vizChart").append("svg")
									 .attr(
									 	"width",
									 	width + margin.left
									 	+ margin.right)
									 .attr(
									 	"height",
									 	height + margin.top
									 	+ margin.bottom)
									 .attr(
									 	"margin-left",
									 	margin.left
									 	)
									 .attr(
									 	"margin-top",
									 	margin.top
									 	);
									/*
									 * Draw the history flow
									 */
									// refresh the chart
									$.ajax({
										type : 'POST',
										url : window.location.href + 'viz?doc_id=' + doc_id,
										contentType : 'application/octet-stream; charset=utf-8',
										success : function(result) {
											console.log("Start Redraw Visualization");

											var dataset = $.parseJSON(result);
											historyflow(svg, width, height, dataset, true);
											$('#vizChart').fadeIn();
										}
									});


								});
}
else{
	$('#vizChart').fadeOut(1000,function(){
		$('#vizChart').empty();
		var doc_id = $('#change_doc_id').val();
									/*
									 ** To Prepare the SVG Convas for drawing the history flow
									 */
									 var width = 1280, height = 900, margin = {
									 	'top' : 20,
									 	'right' : 10,
									 	'bottom' : 10,
									 	'left' : 10
									 };
									 var svg = d3.select("#vizChart").append("svg")
									 .attr(
									 	"width",
									 	width + margin.left
									 	+ margin.right)
									 .attr(
									 	"height",
									 	height + margin.top
									 	+ margin.bottom)
									 .attr(
									 	"margin-left",
									 	margin.left
									 	)
									 .attr(
									 	"margin-top",
									 	margin.top
									 	);
									/*
									 * Draw the history flow
									 */
									// refresh the chart
									$.ajax({
										type : 'POST',
										url : window.location.href + 'viz?doc_id=' + doc_id,
										contentType : 'application/octet-stream; charset=utf-8',
										success : function(result) {
											console.log("Start Redraw Visualization");

											var dataset = $.parseJSON(result);
											historyflow(svg, width, height, dataset);
											$('#vizChart').fadeIn();
										}
									});


								});
}
});

$('#disconnect').button();
$('#disconnect').click(helper.disconnectServer);



/*
 * Fire an event after user chooses a file
 */
$('.createPicker2').click(createPicker);

						//$('#createPicker2').attr("disabled", true);

						$('#saveButton').button();
						$('#saveButton').attr("disabled",
							true);

						$('#saveButton').click(helper.saveImage);

						/**
						 * Deal with progress bar
						 */
						 $('.progressBar').val(0);

						 // $('#progressBar').progressbar({
						 // 	value : 0
						 // });

						 $( "#dialog_form" ).dialog({
						 	autoOpen: false,
						 	height: 300,
						 	width: 500,
						 	modal: true,
						 	buttons: {
						 		"Show Content": function() {
						 			var doc_id = $('#change_doc_id').val();
						 			var seg_id = $('#change_seg_id').val();
						 			helper.retrieveSegmentContent(doc_id, seg_id);
						 			$( this ).dialog( "close" );
						 		},
						 		"Change Author": function() {
						 			var doc_id = $('#change_doc_id').val();
						 			var seg_id = $('#change_seg_id').val();
						 			var author_id = $('#author_list').val();
						 			var revision_id = $('#change_rev_id').val();
						 			helper.changeSegmentAuthor(doc_id, revision_id, seg_id, author_id);
						 			$( this ).dialog( "close" );
						 		},
						 		Cancel: function() {
						 			$( this ).dialog( "close" );
						 		}
						 	}
						 });

						 if ($('[data-clientid="YOUR_CLIENT_ID"]').length > 0) {
						 	alert('This sample requires your OAuth credentials (client ID) '
						 		+ 'from the Google APIs console:\n'
						 		+ '    https://code.google.com/apis/console/#:access\n\n'
						 		+ 'Find and replace YOUR_CLIENT_ID with your client ID and '
						 		+ 'YOUR_CLIENT_SECRET with your client secret in the project sources.');
						 }

						});

	/**
	 * Calls the helper method that handles the authentication flow.
	 *
	 * @param {Object} authResult An Object which contains the access token and
	 *   other authentication information.
	 */
	 function onSignInCallback(authResult) {
	 	helper.onSignInCallback(authResult);
	 }

	 function onApiLoad() {
	 	gapi.load('picker');
	 	pickerApiLoaded = true;
	 	$('.createPicker2').attr("disabled", false);
	 	console.log("point0");
	 }

	 function createPicker() {
		// Deal with progressBar
		// $("#progressBar").progressbar({
		// 	value : 0
		// });

		$('.progressBar').val(0);

		console.log("point1");
		helper.createPicker(helper.authResult.access_token);

		return false;
	}

	// A simple rendering implementation.
	function historyflow(svg, width, height, dataset, timescale_flag) {

		var color = d3.scale.category10(), margin = {
			'top' : 150,
			'right' : 20,
			'bottom' : (height / 8),
			'left' : 60
		}, barHeight = 10;

		/*
		 * Start the core visuzalization
		 */
		 var revisions = dataset.revisions;
		 var authors = dataset.authors;
		 var segments = dataset.segments;
		 var doc_id = dataset.docId;
		 var doc_name = dataset.docName;

		 timescale_flag = typeof timescale_flag !== 'undefined' ? timescale_flag : false;

		 var authorOptions = d3.select("#author_list")
		 .selectAll("option").data(authors).enter().append("option")
		 .attr("value", function(d,i){ return i; })
		 .text(function(d){ return d; })

		 var yScale = d3.scale.linear().domain(
		 	[ 0, d3.max(revisions, function(d) {
		 		return d.revisionLength;
		 	}) ]).range([ 0, height - margin.top - margin.bottom ]);

		 var yAxis = d3.svg.axis().scale(yScale).orient("right").ticks(10);
		 svg.append("g").attr("class", "axis").attr("transform",
		 	"translate(" + (margin.left - 55) + "," + margin.top + ")")
		 .call(yAxis);

		 var legend = svg.selectAll("authorGroup").data(authors).enter().append(
		 	"rect").attr("class", "segment").attr("x", 0).attr("y",
		 	function(d, i) {
		 		return i * (barHeight + 5 );
		 	})
		 	.attr("width", 40)
		 	.attr("height", barHeight).attr(
		 		"fill", function(d, i) {
		 			return color(i);
		 		}).attr(
		 		"transform",
		 		"translate(" + (margin.left )+ ","
		 			+ (height - margin.bottom ) + ")");

		 		var legendText = svg.selectAll("authorText").data(authors).enter()
		 		.append("text").attr("x", 40 + 10).attr("y", function(d, i) {
		 			return i * (barHeight + 5);
		 		})
		 		.attr("font-family", "sans-serif").attr("font-size", "16px")
		 		.attr("fill", "black").text(
		 			function(d) {
		 				return d;
		 			}).attr(
		 			"transform",
		 			"translate(" + (margin.left )
		 				+ "," + (height - margin.bottom + (barHeight ) ) + ")");

		 			var titleText = svg.append("text").attr("x",11).attr("y",16).attr("font-family", "sans-serif").attr("font-size", "20px").text(""+doc_name);

		 			if(timescale_flag==false){

		 				var xScale = d3.scale.ordinal().domain(d3.range(revisions.length))
		 				.rangeRoundBands([ 0, width - margin.left - margin.right ], 0.5);


		// time
		var dateLabel2 = svg.selectAll("dateLabel2").data(revisions).enter()
		.append("text").attr("x", function(d, i) {
			return 0;
		}).attr("y", function(d, i) {
			return xScale(i);
		}).attr("font-family", "sans-serif")
		.attr("font-size", "14px")
		.attr("fill", "black")
		.html(
			function(d) {
				return d.time.substring(5, 10) + " " + d.time.substring(11, 16);
			})
		.attr("transform","translate(" + (margin.left + 15) + "," + (margin.top- (5*barHeight)) + ") rotate(-90)");

		/**
		 * Draw the multi author labl on top of each one
		 */
		 for(var index = 0; index< revisions.length; index++){
		 	var rev = revisions[index];
			//deal with multi author
			if($.isArray(rev.authorId)){
				svg.selectAll("authorLabel_"+index).data(rev.authorId).enter().append("rect")
				.attr("x", function() {
					return xScale(index);
				})
				.attr("y", function(d,i){
					return i*(barHeight + 1);
				})
				.attr("width", xScale.rangeBand())
				.attr("height", barHeight)
				.style("fill", function(d, i) {
					return color(d);
				})
				.attr(
					"transform", "translate(" + margin.left + "," + (margin.top - (5*barHeight))
						+ ")");
			}
			//deal with the old version single author heritage
			else{
				svg.append("rect")
				.attr("x", function() {
					return xScale(index);
				})
				.attr("y", 0)
				.attr("width", xScale.rangeBand())
				.attr("height", barHeight)
				.style("fill",  function(){
					return color(rev.authorId);
				})
				.attr(
					"transform", "translate(" + margin.left + "," + (margin.top - (5*barHeight))
						+ ")");
			}
		}


		// segment rectangles
		var groups = svg.selectAll("rectGroup").data(revisions).enter().append(
			"g").attr("class", "rectGroup").attr("transform",
			"translate(" + margin.left + "," + margin.top + ")");

		var revisionIndex = -1, revisionIndex2 = -1; //one for calculating x; one for calculating rev_index
		var accumulateSegLength = 0;
		var displayGroups = function(groups, start, end) {
			return groups
			.filter(function(d, i) {
				return i >= start && i <= end;
			})
			.selectAll("rect")
			.data(function(d) {
				if (d.segments.length != 0)
					return d.segments;
				else
					return [ -1 ];
			})
			.enter()
			.append("rect")
			.attr("class", "segment")
			.attr("x", function(d, i) {
				if (i == 0)
					revisionIndex++;
				return xScale(revisionIndex);
			})
			.attr("rev",function(d, i) {
				if (i == 0)
					revisionIndex2++;
				return revisionIndex2;
			})
			.attr(
				"y",
				function(d, i) {
					if (i == 0) {
						if (d == -1)
							return yScale(0);
						else {
							accumulateSegLength = segments[d].segmentLength;
							return yScale(accumulateSegLength
								- segments[d].segmentLength);
						}
					} else {
						accumulateSegLength += segments[d].segmentLength;
						return yScale(accumulateSegLength
							- segments[d].segmentLength);
					}
				})
			.attr("width", xScale.rangeBand())
			.attr("height",
				function(d) {
					if (d == -1)
						return 0;
					else
						return yScale(segments[d].segmentLength);
				})
			.attr("fill", function(d, i) {
				if (d != -1)
					return color(segments[d].authorId)
			})
			.on("click", function(d,i) {
				$('#change_doc_id').val(doc_id);
				$('#change_seg_id').val(d);
				$('#change_rev_id').val($(this).attr("rev"));
				$( "#dialog_form" ).dialog( "open" );

			});

		}

		displayGroups(groups, 0, 100);

		//===============================
		var link = [], preSegment = [];
		for (var j = 0; j < revisions.length - 1; j++) {
			link[j] = [];//link[j] represent the link between revision j and j+1
			preSegment = revisions[j].segments; //revision j segments
			newSegment = revisions[j + 1].segments; //revision j+1 segments
			//iterate revision j+1 segments to find father segment (segmentId) or it own(-1) in the previous revision
			for (var k = 0; k < newSegment.length; k++) {
				// If fatherSegmentIndex<0, it is not a child segment, either has a link to itself, or no link
				if (segments[newSegment[k]].fatherSegmentIndex < 0) {
					preIndex = preSegment.indexOf(newSegment[k]);
					//preIndex = -1 means that the segment is not in the previous revision
					if (preIndex != -1) {
						link[j].push([ preSegment[preIndex], newSegment[k] ]);
					} else {
						//No link
					}
				} else {
					// fatherSegmentIndex>0 it's a child segment, need to calculate the offset and position
					preIndex = preSegment
					.indexOf(segments[newSegment[k]].fatherSegmentIndex);
					//If preindex != -1 means, the father is in previous revision, so link the fathter segment and child segment
					if (preIndex != -1) {
						link[j].push([ preSegment[preIndex], newSegment[k] ]);
					}
					// If preindex = -1 means, the father is not in previous revision, so link the child segment and itself in previsous version
					else {
						preIndex = preSegment.indexOf(newSegment[k]);
						if (preIndex != -1) {
							link[j]
							.push([ preSegment[preIndex], newSegment[k] ]);
						} else {
							// means it has a father, but it's not in previous version,
							alert("link compute error" + preIndex + " "
								+ segments[newSegment[k]]);
							//console.log(segments[newSegment[k]]);
						}
					}
				}
			}//end of Segments  for loop
			// If there's no link at all, put a empty link for visualize reason
			if (link[j].length == 0) {
				link[j].push([ -1, -1 ]);
			}
		}// End of Revisions For loop

		var linkGroups = svg.selectAll("linkGroup").data(link).enter().append(
			"g").attr("class", "linkGroup").attr(
			"transform",
			"translate(" + (margin.left + xScale.rangeBand()) + ","
				+ margin.top + ")");

			var linkRevisionIndex = -1;
			var displayLinks = function(linkGroups, start1, end1) {
				return linkGroups
				.filter(function(d, i) {
					return i >= start1 && i <= end1;
				})
				.selectAll("link")
				.data(function(d) {
					return d;
				})
				.enter()
				.append("path")
				.attr("class", "link")
				.attr(
					"d",
					function(d, i) {
						if (i == 0) {
							linkRevisionIndex++;
							accumulateSegLength1 = 0;
							accumulateSegLength2 = 0;
						}
								// If d[1] = -1 means it has only an empty link (-1,-1)
								if (d[1] == -1) {
									return "";
								} else {
									x0 = xScale(linkRevisionIndex);
									var tempSegments1 = revisions[linkRevisionIndex].segments;
									var tempSegments2 = revisions[linkRevisionIndex + 1].segments;

									var index1 = tempSegments1.indexOf(d[0]);
									var index2 = tempSegments2.indexOf(d[1]);

									var accumulateSegLength1 = 0, accumulateSegLength2 = 0;

									for (var q = 0; q < index1; q++) {
										accumulateSegLength1 += segments[tempSegments1[q]].segmentLength;
									}
									for (var q = 0; q < index2; q++) {
										accumulateSegLength2 += segments[tempSegments2[q]].segmentLength;
									}

									if (d[1] == d[0]) {
										y0 = yScale(accumulateSegLength1);
									} else {
										y0 = yScale(accumulateSegLength1
											+ segments[d[1]].offsetInFatherSegment);
									}
									y1 = yScale(accumulateSegLength2);

									x1 = x0 + xScale.rangeBand();
									dy = yScale(segments[d[1]].segmentLength);

									return "M " + x0 + "," + y0 + " " + x0
									+ "," + (y0 + dy) + " " + x1 + ","
									+ (y1 + dy) + " " + x1 + "," + y1
									+ "Z";
								}

							}).attr("fill", function(d, i) {
								if (d[1] != -1)
									return color(segments[d[1]].authorId);
							}).attr("opacity", 0.8);

						}

						displayLinks(linkGroups, 0, 100);
					}
					/* generate timescale historyflow instead of equaling distance */
					else{

						var mindate = new Date(revisions[0].time),maxdate = new Date(revisions[(revisions.length-1)].time);
						var xScale = d3.time.scale().domain([mindate, maxdate])
						.range([ 0, width - margin.left - margin.right ]);

						var barWidth = 5;

		// time
		var dateLabel2 = svg.selectAll("dateLabel2").data(revisions).enter()
		.append("text")
		.attr("x", function(d, i) {
			return 0;
		})
		.attr("y", function(d, i) {
			return xScale(new Date(d.time));
		})
		.attr("font-family", "sans-serif").attr("font-size", "14px")
		.attr("fill", "black").html(
			function(d) {
				return d.time.substring(5, 10) + " " + d.time.substring(11, 16);
			}).attr(

			"transform","translate(" + (margin.left + 10) + "," + (margin.top-(5*barHeight)) + ") rotate(-90)");

		/**
		 * Draw the multi author labl on top of each one
		 */
		 for(var index=0; index< revisions.length; index++){
		 	var rev = revisions[index];
			//deal with multi author
			if($.isArray(rev.authorId)){
				svg.selectAll("authorLabel_"+index).data(revisions[index].authorId).enter().append("rect")
				.attr("x", function() {
					return xScale(new Date(revisions[index].time));
				})
				.attr("y", function(d,i){return (barHeight+1)*i;})
				.attr("width", barWidth)
				.attr("height", barHeight)
				.style("fill", function(d, i) {
					return color(d);
				})
				.attr(
					"transform", "translate(" + margin.left + "," + (margin.top - (5*barHeight))
						+ ")");
			}
			//deal with the old version single author heritage
			else{
				svg.append("rect")
				.attr("x", function() {
					return xScale(new Date(rev.time));
				})
				.attr("y", 0)
				.attr("width", barWidth)
				.attr("height", barHeight)
				.style("fill",  function(){
					return color(rev.authorId);
				})
				.attr(
					"transform", "translate(" + margin.left + "," + (margin.top - (5*barHeight))
						+ ")");
			}
		}

		/*
		//for each revision, mark the author for it above the axis
		svg.selectAll("authorLabel").data(revisions).enter().append("rect")
				.attr("x", function(d, i) {
					return xScale(new Date(d.time));
				}).attr("width", barWidth)
				.attr("height", 20).style(
						"fill", function(d) {
							return color(d.authorId);
						}).attr(
						"transform",
						"translate(" + margin.left + "," + (margin.top - 30)
								+ ")");
*/
var groups = svg.selectAll("rectGroup").data(revisions).enter().append(
	"g").attr("class", "rectGroup").attr("transform",
	"translate(" + margin.left + "," + margin.top + ")");

	var revisionIndex = -1, revisionIndex2 = -1;
	var accumulateSegLength = 0;
	var displayGroups = function(groups, start, end) {
		return groups
		.filter(function(d, i) {
			return i >= start && i <= end;
		})
		.selectAll("rect")
		.data(function(d) {
			if (d.segments.length != 0)
				return d.segments;
			else
				return [ -1 ];
		})
		.enter()
		.append("rect")
		.attr("class", "segment")
		.attr("x", function(d, i) {
			if (i == 0)
				revisionIndex++;
			return xScale(new Date(revisions[revisionIndex].time));
		})
		.attr("rev",function(d, i) {
			if (i == 0)
				revisionIndex2++;
			return revisionIndex2;
		})
		.attr(
			"y",
			function(d, i) {
				if (i == 0) {
					if (d == -1)
						return yScale(0);
					else {
						accumulateSegLength = segments[d].segmentLength;
						return yScale(accumulateSegLength
							- segments[d].segmentLength);
					}
				} else {
					accumulateSegLength += segments[d].segmentLength;
					return yScale(accumulateSegLength
						- segments[d].segmentLength);
				}
			}).attr("width", barWidth).attr("height",
			function(d) {
				if (d == -1)
					return 0;
				else
					return yScale(segments[d].segmentLength);
			}).attr("fill", function(d, i) {
				if (d != -1)
					return color(segments[d].authorId)
			}).on("click", function(d) {
				$('#change_doc_id').val(doc_id);
				$('#change_seg_id').val(d);
				$('#change_rev_id').val($(this).attr("rev"));
				$( "#dialog_form" ).dialog( "open" );

			});
		}

		displayGroups(groups, 0, 100);

		//===============================
		var link = [], preSegment = [];
		for (var j = 0; j < revisions.length - 1; j++) {
			link[j] = [];//link[j] represent the link between revision j and j+1
			preSegment = revisions[j].segments; //revision j segments
			newSegment = revisions[j + 1].segments; //revision j+1 segments
			//iterate revision j+1 segments to find father segment (segmentId) or it own(-1) in the previous revision
			for (var k = 0; k < newSegment.length; k++) {
				// If fatherSegmentIndex<0, it is not a child segment, either has a link to itself, or no link
				if (segments[newSegment[k]].fatherSegmentIndex < 0) {
					preIndex = preSegment.indexOf(newSegment[k]);
					//preIndex = -1 means that the segment is not in the previous revision
					if (preIndex != -1) {
						link[j].push([ preSegment[preIndex], newSegment[k] ]);
					} else {
						//No link
					}
				} else {
					// fatherSegmentIndex>0 it's a child segment, need to calculate the offset and position
					preIndex = preSegment
					.indexOf(segments[newSegment[k]].fatherSegmentIndex);
					//If preindex != -1 means, the father is in previous revision, so link the fathter segment and child segment
					if (preIndex != -1) {
						link[j].push([ preSegment[preIndex], newSegment[k] ]);
					}
					// If preindex = -1 means, the father is not in previous revision, so link the child segment and itself in previsous version
					else {
						preIndex = preSegment.indexOf(newSegment[k]);
						if (preIndex != -1) {
							link[j]
							.push([ preSegment[preIndex], newSegment[k] ]);
						} else {
							// means it has a father, but it's not in previous version,
							alert("link compute error" + preIndex + " "
								+ segments[newSegment[k]]);
							//console.log(segments[newSegment[k]]);
						}
					}
				}
			}//end of Segments  for loop
			// If there's no link at all, put a empty link for visualize reason
			if (link[j].length == 0) {
				link[j].push([ -1, -1 ]);
			}
		}// End of Revisions For loop

		var linkGroups = svg.selectAll("linkGroup").data(link).enter().append(
			"g").attr("class", "linkGroup").attr(
			"transform",
			"translate(" + (margin.left + barWidth) + ","
				+ margin.top + ")");

			var linkRevisionIndex = -1;
			var displayLinks = function(linkGroups, start1, end1) {
				return linkGroups
				.filter(function(d, i) {
					return i >= start1 && i <= end1;
				})
				.selectAll("link")
				.data(function(d) {
					return d;
				})
				.enter()
				.append("path")
				.attr("class", "link")
				.attr(
					"d",
					function(d, i) {
						if (i == 0) {
							linkRevisionIndex++;
							accumulateSegLength1 = 0;
							accumulateSegLength2 = 0;
						}
								// If d[1] = -1 means it has only an empty link (-1,-1)
								if (d[1] == -1) {
									return "";
								} else {
									x0 = xScale(new Date(revisions[linkRevisionIndex].time));
									var tempSegments1 = revisions[linkRevisionIndex].segments;
									var tempSegments2 = revisions[linkRevisionIndex + 1].segments;

									var index1 = tempSegments1.indexOf(d[0]);
									var index2 = tempSegments2.indexOf(d[1]);

									var accumulateSegLength1 = 0, accumulateSegLength2 = 0;

									for (var q = 0; q < index1; q++) {
										accumulateSegLength1 += segments[tempSegments1[q]].segmentLength;
									}
									for (var q = 0; q < index2; q++) {
										accumulateSegLength2 += segments[tempSegments2[q]].segmentLength;
									}

									if (d[1] == d[0]) {
										y0 = yScale(accumulateSegLength1);
									} else {
										y0 = yScale(accumulateSegLength1
											+ segments[d[1]].offsetInFatherSegment);
									}
									y1 = yScale(accumulateSegLength2);

									x1 = xScale(new Date(revisions[linkRevisionIndex+1].time));
									dy = yScale(segments[d[1]].segmentLength);

									return "M " + x0 + "," + y0 + " " + x0
									+ "," + (y0 + dy) + " " + x1 + ","
									+ (y1 + dy) + " " + x1 + "," + y1
									+ "Z";
								}

							}).attr("fill", function(d, i) {
								if (d[1] != -1)
									return color(segments[d[1]].authorId);
							}).attr("opacity", 0.8);

						}

						displayLinks(linkGroups, 0, 100);
					}

				}
			</script>
			<script
			src="//apis.google.com/js/api.js?onload=onApiLoad"
			type="text/javascript"></script>
			</html>
